<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="partials/head :: head('Property listing')"/>
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.js'></script>
    <script src="/keys.js"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.css' rel='stylesheet'/>

</head>


<body>
<nav th:replace="partials/navbar.html :: navbar"/>
<h1>Single House Listing</h1>
<div>
    <p id="houseAddress" th:text="${house.address}"/>
    <p id="houseCity" th:text="${house.city}"/>
    <p th:text="${house.description}"/>
    <p id="houseState" th:text="${house.state}"/>
    <p id="houseZipcode" th:text="${house.zipcode}"/>


    <!--mapbox here-->
    <div id='map' style='width: 400px; height: 300px;' class=""></div>
    <script>

        var singleHouseAddress = $('#houseAddress').text();
        var singleHouseCity = $('#houseCity').text();
        var singleHouseState = $('#houseState').text();
        var singleHouseZipcode = $('#houseZipcode').text();
        console.log(singleHouseAddress);

        mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [-98.4936, 29.4241], // starting position [lng, lat]
            zoom: 8.7 // starting zoom. This zoom covers 1604 loop
        });

        map.addControl(new mapboxgl.NavigationControl());

        var marker = new mapboxgl.Marker({
            draggable: false,
            color: "red"
        }).setLngLat([-98.4936, 29.4241])
            .addTo(map);

        var popup = new mapboxgl.Popup()
            .setLngLat(marker.getLngLat())
            .setHTML("<h6>" + singleHouseAddress + "</h6>")
            .setMaxWidth("300px")
        marker.setPopup(popup);

        geocode(singleHouseAddress, MAPBOX_ACCESS_TOKEN).then(function (info) {
            console.log(info)
            var singleHouseMarker1 = {
                lng: info[0],
                lat: info[1]
            };
            marker.setLngLat(singleHouseMarker1);
            popup.setHTML("<h3>" + singleHouseAddress + "</h3>");
        });


        // GEOCODE FUNCTION
        function geocode(search, token) {
            var baseUrl = 'https://api.mapbox.com';
            var endPoint = '/geocoding/v5/mapbox.places/';
            return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
                .then(function (res) {
                    return res.json();
                    // to get all the data from the request, comment out the following three lines...
                }).then(function (data) {
                    return data.features[0].center;
                });
        }

    </script>

    <!--    end of map box-->

    <div th:if="${isHouseOwner}">
        <a th:href="@{/houses/edit/{id}(id=${house.id})}" class="btn btn-primary">Edit</a>
        <form th:action="@{/houses/delete/{id}(id=${house.id})}" method="post">
            <input type="submit" class="btn btn-primary" value="Delete"/>
        </form>
    </div>

</div>

<!--mapbox scripts-->
<!--<script src="/keys.js"></script>-->
<!--<script src='https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.js'></script>-->
<!--<link href='https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.css' rel='stylesheet' />-->
<!--mapbox end-->
<footer th:replace="partials/footer.html :: footer"/>
<div th:replace="partials/scripts.html :: scripts"/>
</body>

</html>